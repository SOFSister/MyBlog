<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>gRPC学习笔记 | feedsheep</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="现在不好好学习以后怎么去异世界当勇者">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.d252283e.css" as="style"><link rel="preload" href="/assets/js/app.27c88f04.js" as="script"><link rel="preload" href="/assets/js/3.c6d46792.js" as="script"><link rel="preload" href="/assets/js/1.1cb9ffe8.js" as="script"><link rel="preload" href="/assets/js/9.f28a3137.js" as="script"><link rel="prefetch" href="/assets/js/10.d58e60d3.js"><link rel="prefetch" href="/assets/js/11.0654bd08.js"><link rel="prefetch" href="/assets/js/12.1d964e16.js"><link rel="prefetch" href="/assets/js/13.c4541192.js"><link rel="prefetch" href="/assets/js/14.13e2b74f.js"><link rel="prefetch" href="/assets/js/15.73060470.js"><link rel="prefetch" href="/assets/js/16.453b4a23.js"><link rel="prefetch" href="/assets/js/17.f455a2d3.js"><link rel="prefetch" href="/assets/js/18.2d7439ca.js"><link rel="prefetch" href="/assets/js/19.bab24728.js"><link rel="prefetch" href="/assets/js/20.63dd5460.js"><link rel="prefetch" href="/assets/js/21.3532d6c9.js"><link rel="prefetch" href="/assets/js/22.fe9806c6.js"><link rel="prefetch" href="/assets/js/23.b59959a6.js"><link rel="prefetch" href="/assets/js/24.dac55976.js"><link rel="prefetch" href="/assets/js/25.23376ae6.js"><link rel="prefetch" href="/assets/js/26.023f9552.js"><link rel="prefetch" href="/assets/js/27.56ce0bb3.js"><link rel="prefetch" href="/assets/js/28.404db432.js"><link rel="prefetch" href="/assets/js/29.96a8636f.js"><link rel="prefetch" href="/assets/js/30.9bf85840.js"><link rel="prefetch" href="/assets/js/31.8453bb36.js"><link rel="prefetch" href="/assets/js/32.bf93dcc0.js"><link rel="prefetch" href="/assets/js/33.7a47abbf.js"><link rel="prefetch" href="/assets/js/34.03c559ea.js"><link rel="prefetch" href="/assets/js/35.07426441.js"><link rel="prefetch" href="/assets/js/36.da22f8ec.js"><link rel="prefetch" href="/assets/js/37.d6095ada.js"><link rel="prefetch" href="/assets/js/38.4bda9de4.js"><link rel="prefetch" href="/assets/js/39.01908293.js"><link rel="prefetch" href="/assets/js/4.9118be7c.js"><link rel="prefetch" href="/assets/js/40.fbaa32fc.js"><link rel="prefetch" href="/assets/js/41.08668a5d.js"><link rel="prefetch" href="/assets/js/42.ec0b527f.js"><link rel="prefetch" href="/assets/js/43.7c30e2da.js"><link rel="prefetch" href="/assets/js/44.26f43727.js"><link rel="prefetch" href="/assets/js/5.ebde8174.js"><link rel="prefetch" href="/assets/js/6.fcc95ade.js"><link rel="prefetch" href="/assets/js/7.b2be6908.js"><link rel="prefetch" href="/assets/js/8.946cae2f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d252283e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-999d3bb4><div data-v-999d3bb4><div id="loader-wrapper" class="loading-wrapper" data-v-2c578df8 data-v-999d3bb4 data-v-999d3bb4><div class="loader-main" data-v-2c578df8><div data-v-2c578df8></div><div data-v-2c578df8></div><div data-v-2c578df8></div><div data-v-2c578df8></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-067bd032 data-v-999d3bb4 data-v-999d3bb4><h3 class="title" data-v-067bd032 data-v-067bd032>feedsheep</h3> <p class="description" data-v-067bd032 data-v-067bd032>现在不好好学习以后怎么去异世界当勇者</p> <label id="box" class="inputBox" data-v-067bd032 data-v-067bd032><input type="password" value="" data-v-067bd032> <span data-v-067bd032>Konck! Knock!</span> <button data-v-067bd032>OK</button></label> <div class="footer" data-v-067bd032 data-v-067bd032><span data-v-067bd032><i class="iconfont reco-theme" data-v-067bd032></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-067bd032>vuePress-theme-reco</a></span> <span data-v-067bd032><i class="iconfont reco-copyright" data-v-067bd032></i> <a data-v-067bd032><span data-v-067bd032>feedsheep</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-999d3bb4><header class="navbar" data-v-999d3bb4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="feedsheep" class="logo"> <span class="site-name">feedsheep</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/categories/gRPC/" class="nav-link"><i class="undefined"></i>
  gRPC
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/SSM/" class="nav-link"><i class="undefined"></i>
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/categories/Unity/" class="nav-link"><i class="undefined"></i>
  Unity
</a></li><li class="dropdown-item"><!----> <a href="/categories/redis/" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-suggestion"></i>
      学习
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/docs/Go/" class="nav-link router-link-active"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/docs/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/docs/redis/" class="nav-link"><i class="undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/docs/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/docs/SSM/" class="nav-link"><i class="undefined"></i>
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/docs/Git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/Unity/" class="nav-link"><i class="undefined"></i>
  Unity
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      生活
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/PhotoAlbum/" class="nav-link"><i class="undefined"></i>
  相册
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/SOFSister" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/weixin_48964494?type=blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-999d3bb4></div> <aside class="sidebar" data-v-999d3bb4><div class="personal-info-wrapper" data-v-e2878dae data-v-999d3bb4><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-e2878dae> <h3 class="name" data-v-e2878dae>
    feedsheep
  </h3> <div class="num" data-v-e2878dae><div data-v-e2878dae><h3 data-v-e2878dae>34</h3> <h6 data-v-e2878dae>文章</h6></div> <div data-v-e2878dae><h3 data-v-e2878dae>29</h3> <h6 data-v-e2878dae>标签</h6></div></div> <ul class="social-links" data-v-e2878dae></ul> <hr data-v-e2878dae></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/categories/gRPC/" class="nav-link"><i class="undefined"></i>
  gRPC
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/SSM/" class="nav-link"><i class="undefined"></i>
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/categories/Unity/" class="nav-link"><i class="undefined"></i>
  Unity
</a></li><li class="dropdown-item"><!----> <a href="/categories/redis/" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-suggestion"></i>
      学习
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/docs/Go/" class="nav-link router-link-active"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/docs/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/docs/redis/" class="nav-link"><i class="undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/docs/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/docs/SSM/" class="nav-link"><i class="undefined"></i>
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/docs/Git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/Unity/" class="nav-link"><i class="undefined"></i>
  Unity
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      生活
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/PhotoAlbum/" class="nav-link"><i class="undefined"></i>
  相册
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/SOFSister" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/weixin_48964494?type=blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/docs/Go/" aria-current="page" class="sidebar-link">Go专区</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>gRPC</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html" aria-current="page" class="active sidebar-link">gRPC学习笔记</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-067bd032 data-v-999d3bb4><h3 class="title" data-v-067bd032 data-v-067bd032>gRPC学习笔记</h3> <!----> <label id="box" class="inputBox" data-v-067bd032 data-v-067bd032><input type="password" value="" data-v-067bd032> <span data-v-067bd032>Konck! Knock!</span> <button data-v-067bd032>OK</button></label> <div class="footer" data-v-067bd032 data-v-067bd032><span data-v-067bd032><i class="iconfont reco-theme" data-v-067bd032></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-067bd032>vuePress-theme-reco</a></span> <span data-v-067bd032><i class="iconfont reco-copyright" data-v-067bd032></i> <a data-v-067bd032><span data-v-067bd032>feedsheep</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-999d3bb4><main class="page"><section><div class="page-title"><h1 class="title">gRPC学习笔记</h1> <div data-v-10e19382><i class="iconfont reco-account" data-v-10e19382><span data-v-10e19382>feedsheep</span></i> <i class="iconfont reco-date" data-v-10e19382><span data-v-10e19382>2022/6/22</span></i> <!----> <i class="tags iconfont reco-tag" data-v-10e19382><span class="tag-item" data-v-10e19382>Go</span><span class="tag-item" data-v-10e19382>gRPC</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="认识grpc"><a href="#认识grpc" class="header-anchor">#</a> 认识gRPC</h2> <h3 id="_1-什么是微服务"><a href="#_1-什么是微服务" class="header-anchor">#</a> 1. 什么是微服务</h3> <h4 id="_1-1-单体架构"><a href="#_1-1-单体架构" class="header-anchor">#</a> 1.1 单体架构</h4> <p><img src="/assets/img/image-20220422225410288.7078bb06.png" alt="image-20220422225410288"></p> <p>有一些致命缺点：</p> <ol><li>一旦某个服务宕机，会引起整个应用不可用，隔离性差</li> <li>只能整体应用进行伸缩，浪费资源，可伸缩性差</li> <li>代码耦合在一起，可维护性差</li></ol> <h4 id="_1-2-微服务架构"><a href="#_1-2-微服务架构" class="header-anchor">#</a> 1.2 微服务架构</h4> <p>要想解决上述的单体架构的问题，就需要将服务拆分出来，单独管理和维护。</p> <p><img src="/assets/img/image-20220422231420347.8fcac3c2.png" alt="image-20220422231420347"></p> <p>通过上述的架构，解决了单体架构的弊端。</p> <p>但同时引入了新的问题：</p> <ol><li>代码冗余</li> <li>服务和服务之间存在调用关系</li></ol> <h5 id="_1-2-1-代码冗余问题"><a href="#_1-2-1-代码冗余问题" class="header-anchor">#</a> 1.2.1 代码冗余问题</h5> <blockquote><p>服务未拆分之前，公共的功能有统一的实现，比如认证，授权，限流等，但是服务拆分之后，每一个服务可能都需要实现一遍</p></blockquote> <p>解决方案：</p> <ol><li>由于为了保持对外提供服务的一致性，引入了网关的概念，由网关根据不同的请求，将其转发到不同的服务（路由功能），由于入口的一致性，可以在网关上实现公共的一些功能</li> <li>可以将公共的功能抽取出来，形成一个新的服务，比如统一认证中心</li></ol> <h5 id="_1-2-2-服务之间调用"><a href="#_1-2-2-服务之间调用" class="header-anchor">#</a> 1.2.2 服务之间调用</h5> <p>服务拆分后，服务和服务之间发生的是进程和进程之间的调用，服务器和服务器之间的调用。</p> <p>那么就需要发起网络调用，网络调用我们能立马想起的就是http，但是在微服务架构中，http虽然便捷方便，但性能较低，这时候就需要引入RPC（远程过程调用），通过自定义协议发起TCP调用，来加快传输效率。</p> <blockquote><p>每个服务由于可能分布在成千上百台机器上，服务和服务之间的调用，会出现一些问题，比如，如何知道应该调用哪台机器上的服务，调用方可能需要维护被调用方的地址，这个地址可能很多，增加了额外的负担，这时候就需要引入服务治理.</p></blockquote> <p>服务治理中有一个重要的概念<code>服务发现</code>，服务发现中有一个重要的概念叫做<code>注册中心</code>。</p> <p><img src="/assets/img/image-20220422233632635.7ab664d9.png" alt="image-20220422233632635"></p> <p>每个服务启动的时候，会将自身的服务和ip注册到注册中心，其他服务调用的时候，只需要向注册中心申请地址即可。</p> <blockquote><p>当然，服务和服务之间调用会发生一些问题，为了避免产生连锁的雪崩反应，引入了服务容错，为了追踪一个调用所经过的服务，引入了链路追踪，等等这些就构建了一个微服务的生态</p></blockquote> <h3 id="_2-grpc"><a href="#_2-grpc" class="header-anchor">#</a> 2. gRPC</h3> <blockquote><p>上面我们讲到，服务和服务之间调用需要使用RPC，<code>gRPC</code>是一款<strong>语言中立</strong>、<strong>平台中立</strong>、开源的远程过程调用系统，<code>gRPC</code>客户端和服务端可以在多种环境中运行和交互，例如用<code>java</code>写一个服务端，可以用<code>go</code>语言写客户端调用</p></blockquote> <p>数据在进行网络传输的时候，需要进行序列化，序列化协议有很多种，比如xml, json，protobuf等</p> <p>gRPC默认使用<code>protocol buffers</code>，这是google开源的一套成熟的结构数据序列化机制。</p> <p>在学习gRPC之前，需要先了解<code>protocol buffers</code></p> <p><strong>序列化</strong>：将数据结构或对象转换成二进制串的过程。</p> <p><strong>反序列化</strong>：将在序列化过程中所产生的二进制串转换成数据结构或对象的过程。</p> <h3 id="_3-protobuf"><a href="#_3-protobuf" class="header-anchor">#</a> 3. protobuf</h3> <p>protobuf是谷歌开源的一种数据格式，适合高性能，对响应速度有要求的数据传输场景。因为profobuf是二进制数据格式，需要编码和解码。数据本身不具有可读性。因此只能反序列化之后得到真正可读的数据。</p> <p>优势：</p> <ol><li>序列化后体积相比Json和XML很小，适合网络传输</li> <li>支持跨平台多语言</li> <li>消息格式升级和兼容性还不错</li> <li>序列化反序列化速度很快</li></ol> <h4 id="_3-1-安装"><a href="#_3-1-安装" class="header-anchor">#</a> 3.1 安装</h4> <ul><li><p>第一步：下载通用编译器</p> <p>地址：https://github.com/protocolbuffers/protobuf/releases</p> <p>根据不同的操作系统，下载不同的包，我是windows电脑，解压出来是<code>protoc.exe</code></p> <p><img src="/assets/img/image-20220423001259067.62f86e6e.png" alt="image-20220423001259067"></p></li> <li><p>第二步：配置环境变量</p> <p><img src="data:image/png;base64,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" alt="image-20220423002031614"></p></li> <li><p>第三步：安装go专用的protoc的生成器</p></li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>golang<span class="token operator">/</span>protobuf<span class="token operator">/</span>protoc<span class="token operator">-</span>gen<span class="token operator">-</span><span class="token keyword">go</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装后会在<code>GOPATH</code>目录下生成可执行文件，protobuf的编译器插件<code>protoc-gen-go</code>，执行<code>protoc</code>命令会自动调用这个插件</p> <blockquote><p>如何使用protobuf呢？</p></blockquote> <ol><li>定义了一种源文件，扩展名为 <code>.proto</code>，使用这种源文件，可以定义存储类的内容(消息类型)</li> <li>protobuf有自己的编译器 <code>protoc</code>，可以将 <code>.proto</code> 编译成对应语言的文件，就可以进行使用了</li></ol> <h4 id="_3-2-hello-world"><a href="#_3-2-hello-world" class="header-anchor">#</a> 3.2 hello world</h4> <blockquote><p>假设，我们现在需要传输用户信息，其中有username和age两个字段</p></blockquote> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token comment">// 指定的当前proto语法的版本，有2和3</span>
<span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//option go_package = &quot;path;name&quot;; ath 表示生成的go文件的存放地址，会自动生成目录的</span>
<span class="token comment">// name 表示生成的go文件所属的包名</span>
<span class="token keyword">option</span> go_package<span class="token operator">=</span><span class="token string">&quot;../service&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 指定等会文件生成出来的package</span>
<span class="token keyword">package</span> <span class="token keyword">service</span><span class="token punctuation">;</span>

<span class="token keyword">message</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> username <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">int32</span> age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>运行protoc命令编译成go中间文件</strong></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code># 编译user<span class="token punctuation">.</span>proto之后输出到service文件夹
protoc <span class="token operator">--</span>go_out<span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>service user<span class="token punctuation">.</span>proto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>测试</strong></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;google.golang.org/protobuf/proto&quot;</span>
	<span class="token string">&quot;testProto/service&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	user <span class="token operator">:=</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>User<span class="token punctuation">{</span>
		Username<span class="token punctuation">:</span> <span class="token string">&quot;mszlu&quot;</span><span class="token punctuation">,</span>
		Age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//转换为protobuf</span>
	marshal<span class="token punctuation">,</span> err <span class="token operator">:=</span> proto<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	newUser <span class="token operator">:=</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span>
	err <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>marshal<span class="token punctuation">,</span> newUser<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>newUser<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="_3-3-proto文件介绍"><a href="#_3-3-proto文件介绍" class="header-anchor">#</a> 3.3 proto文件介绍</h4> <h5 id="_3-3-1-message介绍"><a href="#_3-3-1-message介绍" class="header-anchor">#</a> 3.3.1 message介绍</h5> <p><code>message</code>：<code>protobuf</code>中定义一个消息类型是通过关键字<code>message</code>字段指定的。</p> <p>消息就是需要传输的数据格式的定义。</p> <p>message关键字类似于C++中的class，Java中的class，go中的struct</p> <p>例如：</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> username <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">int32</span> age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在消息中承载的数据分别对应于每一个字段。</p> <p>其中每个字段都有一个名字和一种类型  。</p> <h5 id="_3-3-2-字段规则"><a href="#_3-3-2-字段规则" class="header-anchor">#</a> 3.3.2 字段规则</h5> <ul><li><code>required</code>:消息体中必填字段，不设置会导致编解码异常。（例如位置1）</li> <li><code>optional</code>: 消息体中可选字段。（例如位置2）</li> <li><code>repeated</code>: 消息体中可重复字段，重复的值的顺序会被保留（例如位置3）在go中重复的会被定义为切片。</li></ul> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> username <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">int32</span> age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">optional</span> <span class="token builtin">string</span> password <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">repeated</span> <span class="token builtin">string</span> address <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="_3-3-3-字段映射"><a href="#_3-3-3-字段映射" class="header-anchor">#</a> 3.3.3 字段映射</h5> <table><thead><tr><th><strong>.proto Type</strong></th> <th><strong>Notes</strong></th> <th><strong>C++ Type</strong></th> <th><strong>Python Type</strong></th> <th><strong>Go Type</strong></th></tr></thead> <tbody><tr><td>double</td> <td></td> <td>double</td> <td>float</td> <td>float64</td></tr> <tr><td>float</td> <td></td> <td>float</td> <td>float</td> <td>float32</td></tr> <tr><td>int32</td> <td>使用变长编码，对于负值的效率很低，如果你的域有 可能有负值，请使用sint64替代</td> <td>int32</td> <td>int</td> <td>int32</td></tr> <tr><td>uint32</td> <td>使用变长编码</td> <td>uint32</td> <td>int/long</td> <td>uint32</td></tr> <tr><td>uint64</td> <td>使用变长编码</td> <td>uint64</td> <td>int/long</td> <td>uint64</td></tr> <tr><td>sint32</td> <td>使用变长编码，这些编码在负值时比int32高效的多</td> <td>int32</td> <td>int</td> <td>int32</td></tr> <tr><td>sint64</td> <td>使用变长编码，有符号的整型值。编码时比通常的 int64高效。</td> <td>int64</td> <td>int/long</td> <td>int64</td></tr> <tr><td>fixed32</td> <td>总是4个字节，如果数值总是比总是比228大的话，这 个类型会比uint32高效。</td> <td>uint32</td> <td>int</td> <td>uint32</td></tr> <tr><td>fixed64</td> <td>总是8个字节，如果数值总是比总是比256大的话，这 个类型会比uint64高效。</td> <td>uint64</td> <td>int/long</td> <td>uint64</td></tr> <tr><td>sfixed32</td> <td>总是4个字节</td> <td>int32</td> <td>int</td> <td>int32</td></tr> <tr><td>sfixed32</td> <td>总是4个字节</td> <td>int32</td> <td>int</td> <td>int32</td></tr> <tr><td>sfixed64</td> <td>总是8个字节</td> <td>int64</td> <td>int/long</td> <td>int64</td></tr> <tr><td>bool</td> <td></td> <td>bool</td> <td>bool</td> <td>bool</td></tr> <tr><td>string</td> <td>一个字符串必须是UTF-8编码或者7-bit ASCII编码的文 本。</td> <td>string</td> <td>str/unicode</td> <td>string</td></tr> <tr><td>bytes</td> <td>可能包含任意顺序的字节数据。</td> <td>string</td> <td>str</td> <td>[]byte</td></tr></tbody></table> <h5 id="_3-3-4-默认值"><a href="#_3-3-4-默认值" class="header-anchor">#</a> 3.3.4 默认值</h5> <p>protobuf3 删除了 protobuf2 中用来设置默认值的 default 关键字，取而代之的是protobuf3为各类型定义的默认值，也就是约定的默认值，如下表所示：</p> <table><thead><tr><th style="text-align:left;">类型</th> <th style="text-align:left;">默认值</th></tr></thead> <tbody><tr><td style="text-align:left;">bool</td> <td style="text-align:left;">false</td></tr> <tr><td style="text-align:left;">整型</td> <td style="text-align:left;">0</td></tr> <tr><td style="text-align:left;">string</td> <td style="text-align:left;">空字符串&quot;&quot;</td></tr> <tr><td style="text-align:left;">枚举enum</td> <td style="text-align:left;">第一个枚举元素的值，因为Protobuf3强制要求第一个枚举元素的值必须是0，所以枚举的默认值就是0；</td></tr> <tr><td style="text-align:left;">message</td> <td style="text-align:left;">不是null，而是DEFAULT_INSTANCE</td></tr></tbody></table> <h5 id="_3-3-5-标识号"><a href="#_3-3-5-标识号" class="header-anchor">#</a> 3.3.5 标识号</h5> <p><code>标识号</code>：在消息体的定义中，每个字段都必须要有一个唯一的标识号，标识号是[0,2^29-1]范围内的一个整数。</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span> 

  <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// (位置1)</span>
  <span class="token builtin">int32</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  
  <span class="token keyword">optional</span> <span class="token builtin">string</span> email <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  
  <span class="token keyword">repeated</span> <span class="token builtin">string</span> phones <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// (位置4)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以Person为例，name=1，id=2, email=3, phones=4 中的1-4就是标识号。</p> <h5 id="_3-3-6-定义多个消息类型"><a href="#_3-3-6-定义多个消息类型" class="header-anchor">#</a> 3.3.6 定义多个消息类型</h5> <p>一个proto文件中可以定义多个消息类型</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>message UserRequest <span class="token punctuation">{</span>
  <span class="token builtin">string</span> username <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">int32</span> age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  optional <span class="token builtin">string</span> password <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  repeated <span class="token builtin">string</span> address <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message UserResponse <span class="token punctuation">{</span>
  <span class="token builtin">string</span> username <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">int32</span> age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  optional <span class="token builtin">string</span> password <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  repeated <span class="token builtin">string</span> address <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="_3-3-7-嵌套消息"><a href="#_3-3-7-嵌套消息" class="header-anchor">#</a> 3.3.7 嵌套消息</h5> <p>可以在其他消息类型中定义、使用消息类型，在下面的例子中，Person消息就定义在PersonInfo消息内，如  ：</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">PersonInfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">message</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
        <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token builtin">int32</span> height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">repeated</span> <span class="token builtin">int32</span> weight <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
	<span class="token keyword">repeated</span> <span class="token positional-class-name class-name">Person</span> info <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果你想在它的父消息类型的外部重用这个消息类型，你需要以PersonInfo.Person的形式使用它，如：</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">PersonMessage</span> <span class="token punctuation">{</span>
	<span class="token positional-class-name class-name">PersonInfo<span class="token punctuation">.</span>Person</span> info <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当然，你也可以将消息嵌套任意多层，如 :</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">Grandpa</span> <span class="token punctuation">{</span> <span class="token comment">// Level 0</span>
    <span class="token keyword">message</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span> <span class="token comment">// Level 1</span>
        <span class="token keyword">message</span> <span class="token class-name">son</span> <span class="token punctuation">{</span> <span class="token comment">// Level 2</span>
            <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token builtin">int32</span> age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
    <span class="token keyword">message</span> <span class="token class-name">Uncle</span> <span class="token punctuation">{</span> <span class="token comment">// Level 1</span>
        <span class="token keyword">message</span> <span class="token class-name">Son</span> <span class="token punctuation">{</span> <span class="token comment">// Level 2</span>
            <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token builtin">int32</span> age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="_3-3-8-定义服务-service"><a href="#_3-3-8-定义服务-service" class="header-anchor">#</a> 3.3.8 定义服务(Service)</h5> <p>如果想要将消息类型用在RPC系统中，可以在.proto文件中定义一个RPC服务接口，protocol buffer 编译器将会根据所选择的不同语言生成服务接口代码及存根。</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">service</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span>
	<span class="token comment">//rpc 服务的函数名 （传入参数）返回（返回参数）</span>
	<span class="token keyword">rpc</span> <span class="token function">Search</span> <span class="token punctuation">(</span><span class="token class-name">SearchRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">SearchResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上述代表表示，定义了一个RPC服务，该方法接收SearchRequest返回SearchResponse</p> <h3 id="_4-grpc实例"><a href="#_4-grpc实例" class="header-anchor">#</a> 4. gRPC实例</h3> <h4 id="_4-1-rpc和grpc介绍"><a href="#_4-1-rpc和grpc介绍" class="header-anchor">#</a> 4.1 RPC和gRPC介绍</h4> <p>RPC（Remote Procedure Call）远程过程调用协议，一种通过网络从远程计算机上请求服务，而不需要了解底层网络技术的协议。RPC它假定某些协议的存在，例如TCP/UDP等，为通信程序之间携带信息数据。在OSI网络七层模型中，RPC跨越了传输层和应用层，RPC使得开发包括网络分布式多程序在内的应用程序更加容易。</p> <p>过程是什么？ 过程就是业务处理、计算任务，更直白的说，就是程序，就是像调用本地方法一样调用远程的过程</p> <p>RPC采用客户端/服务端的模式，通过request-response消息模式实现</p> <p><img src="/assets/img/image-20220424111303405.38ca6426.png" alt="image-20220424111303405"></p> <p>gRPC 里<em>客户端</em>应用可以像调用本地对象一样直接调用另一台不同的机器上<em>服务端</em>应用的方法，使得您能够更容易地创建分布式应用和服务。与许多 RPC 系统类似，gRPC 也是基于以下理念：定义一个<em>服务</em>，指定其能够被远程调用的方法（包含参数和返回类型）。在服务端实现这个接口，并运行一个 gRPC 服务器来处理客户端调用。在客户端拥有一个<em>存根</em>能够像服务端一样的方法。</p> <p><img src="/assets/img/image-20220424111455580.bdbbb602.png" alt="image-20220424111455580"></p> <p>官方网站：https://grpc.io/</p> <p>底层协议：</p> <ul><li>HTTP2: https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md</li> <li>GRPC-WEB ： https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md</li></ul> <h5 id="_4-1-1-http2"><a href="#_4-1-1-http2" class="header-anchor">#</a> 4.1.1 HTTP2</h5> <p><img src="/assets/img/image-20220424112609954.2b3e62bb.png" alt="image-20220424112609954"></p> <ul><li>HTTP/1里的header对应HTTP/2里的 HEADERS frame</li> <li>HTTP/1里的payload对应HTTP/2里的 DATA frame</li></ul> <p>gGRPC把元数据放到HTTP/2 Headers里，请求参数序列化之后放到 DATA frame里</p> <p><strong>基于HTTP/2 协议的优点</strong></p> <ol><li>公开标准</li> <li>HTTP/2的前身是Google的<a href="https://en.wikipedia.org/wiki/SPDY" target="_blank" rel="noopener noreferrer">SPDY<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，有经过实践检验</li> <li>HTTP/2 天然支持物联网、手机、浏览器</li> <li>基于HTTP/2 多语言客户端实现容易
<ol><li>每个流行的编程语言都会有成熟的HTTP/2 Client</li> <li>HTTP/2 Client是经过充分测试，可靠的</li> <li>用Client发送HTTP/2请求的难度远低于用socket发送数据包/解析数据包</li></ol></li> <li>HTTP/2支持Stream和流控</li> <li>基于HTTP/2 在Gateway/Proxy很容易支持
<ol><li>nginx和envoy都有支持</li></ol></li> <li>HTTP/2 安全性有保证
<ol><li>HTTP/2 天然支持SSL，当然gRPC可以跑在clear text协议（即不加密）上。</li> <li>很多私有协议的rpc可能自己包装了一层TLS支持，使用起来也非常复杂。开发者是否有足够的安全知识？使用者是否配置对了？运维者是否能正确理解？</li> <li>HTTP/2 在公有网络上的传输上有保证。比如这个<a href="https://en.wikipedia.org/wiki/CRIME" target="_blank" rel="noopener noreferrer">CRIME攻击<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，私有协议很难保证没有这样子的漏洞。</li></ol></li> <li>HTTP/2 鉴权成熟
<ol><li>从HTTP/1发展起来的鉴权系统已经很成熟了，可以无缝用在HTTP/2上</li> <li>可以从前端到后端完全打通的鉴权，不需要做任何转换适配</li></ol></li></ol> <p><strong>基于HTTP/2 协议的缺点</strong></p> <ul><li><p>rpc的元数据的传输不够高效</p> <p>尽管HPAC可以压缩HTTP Header，但是对于rpc来说，确定一个函数调用，可以简化为一个int，只要两端去协商过一次，后面直接查表就可以了，不需要像HPAC那样编码解码。
可以考虑专门对gRPC做一个优化过的HTTP/2解析器，减少一些通用的处理，感觉可以提升性能。</p></li> <li><p>HTTP/2 里一次gRPC调用需要解码两次</p> <p>一次是HEADERS frame，一次是DATA frame。</p></li> <li><p>HTTP/2 标准本身是只有一个TCP连接，但是实际在gRPC里是会有多个TCP连接，使用时需要注意。</p></li></ul> <p>gRPC选择基于HTTP/2，那么它的性能肯定不会是最顶尖的。但是对于rpc来说中庸的qps可以接受，通用和兼容性才是最重要的事情。</p> <ul><li>官方的benchmark：https://grpc.io/docs/guides/benchmarking.html</li> <li>https://github.com/hank-whu/rpc-benchmark</li></ul> <p>gRPC目前是k8s生态里的事实标准，而Kubernetes又是容器编排的事实标准。gRPC已经广泛应用于Istio体系，包括:</p> <ul><li>Envoy与Pilot(现在叫istiod)间的XDS协议</li> <li>mixer的handler扩展协议</li> <li>MCP(控制面的配置分发协议)</li></ul> <p>在Cloud Native的潮流下，开放互通的需求必然会产生基于HTTP/2的RPC。</p> <h4 id="_4-2-实例"><a href="#_4-2-实例" class="header-anchor">#</a> 4.2 实例</h4> <h5 id="_4-2-1-服务端"><a href="#_4-2-1-服务端" class="header-anchor">#</a> 4.2.1 服务端</h5> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 这个就是protobuf的中间文件</span>

<span class="token comment">// 指定的当前proto语法的版本，有2和3</span>
syntax <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
option go_package<span class="token operator">=</span><span class="token string">&quot;../service&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 指定等会文件生成出来的package</span>
<span class="token keyword">package</span> service<span class="token punctuation">;</span>

<span class="token comment">// 定义request model</span>
message ProductRequest<span class="token punctuation">{</span>
	<span class="token builtin">int32</span> prod_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1代表顺序</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义response model</span>
message ProductResponse<span class="token punctuation">{</span>
	<span class="token builtin">int32</span> prod_stock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1代表顺序</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义服务主体</span>
service ProdService<span class="token punctuation">{</span>
    <span class="token comment">// 定义方法</span>
    rpc <span class="token function">GetProductStock</span><span class="token punctuation">(</span>ProductRequest<span class="token punctuation">)</span> <span class="token function">returns</span><span class="token punctuation">(</span>ProductResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>生成：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>protoc --go_out<span class="token operator">=</span>plugins<span class="token operator">=</span>grpc:./ .<span class="token punctuation">\</span>product.proto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>服务端：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;google.golang.org/grpc&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	server <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	service<span class="token punctuation">.</span><span class="token function">RegisterProdServiceServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span>service<span class="token punctuation">.</span>ProductService<span class="token punctuation">)</span>

	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:8002&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;服务监听端口失败&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="_4-2-2-客户端"><a href="#_4-2-2-客户端" class="header-anchor">#</a> 4.2.2 客户端</h5> <p>新建client目录，把上述生成的product.pb.go copy过来</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token comment">// 1. 新建连接，端口是服务端开放的8002端口</span>
	<span class="token comment">// 没有证书会报错</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;:8002&quot;</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 退出时关闭链接</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 2. 调用Product.pb.go中的NewProdServiceClient方法</span>
	productServiceClient <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">NewProdServiceClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

	<span class="token comment">// 3. 直接像调用本地方法一样调用GetProductStock方法</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> productServiceClient<span class="token punctuation">.</span><span class="token function">GetProductStock</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>ProductRequest<span class="token punctuation">{</span>ProdId<span class="token punctuation">:</span> <span class="token number">233</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;调用gRPC方法错误: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;调用gRPC方法成功，ProdStock = &quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>ProdStock<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="认证"><a href="#认证" class="header-anchor">#</a> 认证</h2> <blockquote><p>客户端和服务端之间调用，我们可以通过加入证书的方式，实现调用的安全性</p></blockquote> <p>TLS（Transport Layer Security，安全传输层)，TLS是建立在<code>传输层</code>TCP协议之上的协议，服务于应用层，它的前身是SSL（Secure Socket Layer，安全套接字层），它实现了将应用层的报文进行加密后再交由TCP进行传输的功能。</p> <p>TLS协议主要解决如下三个网络安全问题。</p> <ul><li>保密(message privacy)，保密通过加密encryption实现，所有信息都加密传输，第三方无法嗅探；</li> <li>完整性(message integrity)，通过MAC校验机制，一旦被篡改，通信双方会立刻发现；</li> <li>认证(mutual authentication)，双方认证,双方都可以配备证书，防止身份被冒充；</li></ul> <h3 id="_1-生成自签证书"><a href="#_1-生成自签证书" class="header-anchor">#</a> 1. 生成自签证书</h3> <blockquote><p>生产环境可以购买证书或者使用一些平台发放的免费证书</p></blockquote> <ul><li><p>安装openssl</p> <p>网站下载：http://slproweb.com/products/Win32OpenSSL.html</p> <p>（mac电脑 自行搜索安装）</p></li> <li><p>生成私钥文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">## 需要输入密码</span>
openssl genrsa -des3 -out ca.key <span class="token number">2048</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>创建证书请求</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl req -new -key ca.key -out ca.csr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>生成ca.crt</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl x509 -req -days <span class="token number">365</span> -in ca.csr -signkey ca.key -out ca.crt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <p>找到openssl.cnf 文件</p> <ol><li><p>打开copy_extensions = copy</p></li> <li><p>打开 req_extensions = v3_req</p></li> <li><p>找到[ v3_req ],添加 subjectAltName = @alt_names</p></li> <li><p>添加新的标签 [ alt_names ] , 和标签字段</p> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token section"><span class="token punctuation">[</span> <span class="token section-name selector">alt_names</span> <span class="token punctuation">]</span></span>

<span class="token key attr-name">DNS.1</span> <span class="token punctuation">=</span> <span class="token value attr-value">*.mszlu.com</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>生成证书私钥server.key</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl genpkey -algorithm RSA -out server.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>通过私钥server.key生成证书请求文件server.csr</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl req -new -nodes -key server.key -out server.csr -days <span class="token number">3650</span> -config ./openssl.cnf -extensions v3_req
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>生成SAN证书</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl x509 -req -days <span class="token number">365</span> -in server.csr -out server.pem -CA ca.crt -CAkey ca.key -CAcreateserial -extfile ./openssl.cnf -extensions v3_req
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <ul><li><strong>key：</strong> 服务器上的私钥文件，用于对发送给客户端数据的加密，以及对从客户端接收到数据的解密。</li> <li><strong>csr：</strong> 证书签名请求文件，用于提交给证书颁发机构（CA）对证书签名。</li> <li><strong>crt：</strong> 由证书颁发机构（CA）签名后的证书，或者是开发者自签名的证书，包含证书持有人的信息，持有人的公钥，以及签署者的签名等信息。</li> <li><strong>pem：</strong> 是基于Base64编码的证书格式，扩展名包括PEM、CRT和CER。</li></ul> <p>什么是 SAN？</p> <p>SAN（Subject Alternative Name）是 SSL 标准 x509 中定义的一个扩展。使用了 SAN 字段的 SSL 证书，可以扩展此证书支持的域名，使得一个证书可以支持多个不同域名的解析。</p> <h3 id="_2-服务端应用证书"><a href="#_2-服务端应用证书" class="header-anchor">#</a> 2. 服务端应用证书</h3> <p>将<code>server.key</code>和<code>server.pem</code> copy到程序中</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>

	<span class="token comment">//添加证书</span>
	file<span class="token punctuation">,</span> err2 <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewServerTLSFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;keys/mszlu.pem&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;keys/mszlu.key&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;证书生成错误&quot;</span><span class="token punctuation">,</span>err2<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	rpcServer <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">Creds</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>

	service<span class="token punctuation">.</span><span class="token function">RegisterProdServiceServer</span><span class="token punctuation">(</span>rpcServer<span class="token punctuation">,</span>service<span class="token punctuation">.</span>ProductService<span class="token punctuation">)</span>

	listener <span class="token punctuation">,</span>err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;:8002&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;启动监听出错&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> rpcServer<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;启动服务出错&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;启动grpc服务端成功&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_3-客户端认证"><a href="#_3-客户端认证" class="header-anchor">#</a> 3. 客户端认证</h3> <p>公钥copy到客户端</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	file<span class="token punctuation">,</span> err2 <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewClientTLSFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;client/keys/mszlu.pem&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*.mszlu.com&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;证书错误&quot;</span><span class="token punctuation">,</span>err2<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;:8002&quot;</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;服务端出错，连接不上&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	prodClient <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">NewProdServiceClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>ProductRequest<span class="token punctuation">{</span>
		ProdId<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	stockResponse<span class="token punctuation">,</span> err <span class="token operator">:=</span> prodClient<span class="token punctuation">.</span><span class="token function">GetProductStock</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;查询库存出错&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>stockResponse<span class="token punctuation">.</span>ProdStock<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>上述认证方式为单向认证：</p> <p><img src="/assets/img/1586953-20210625171059706-1447106002-16509094111532.b0e04bd3.png" alt="img"></p> <p>中间人攻击</p> <h3 id="_4-双向认证"><a href="#_4-双向认证" class="header-anchor">#</a> 4. 双向认证</h3> <p><img src="/assets/img/1586953-20210625211235069-195172761-16509094417774.fc57b245.png" alt="img"></p> <p>上面的server.pem和server.key 是服务端的 公钥和私钥。</p> <p>如果双向认证，客户端也需要生成对应的公钥和私钥。</p> <p>私钥：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl genpkey -algorithm RSA -out client.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>证书:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl req -new -nodes -key client.key -out client.csr -days <span class="token number">3650</span> -config ./openssl.cnf -extensions v3_req
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>SAN证书：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl x509 -req -days <span class="token number">365</span> -in client.csr -out client.pem -CA ca.crt -CAkey ca.key -CAcreateserial -extfile ./openssl.cnf -extensions v3_req
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>服务端：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>

	<span class="token comment">//添加证书</span>
	<span class="token comment">//file, err2 := credentials.NewServerTLSFromFile(&quot;keys/mszlu.pem&quot;, &quot;keys/mszlu.key&quot;)</span>
	<span class="token comment">//if err2 != nil {</span>
	<span class="token comment">//	log.Fatal(&quot;证书生成错误&quot;,err2)</span>
	<span class="token comment">//}</span>
	<span class="token comment">// 证书认证-双向认证</span>
	<span class="token comment">// 从证书相关文件中读取和解析信息，得到证书公钥、密钥对</span>
	cert<span class="token punctuation">,</span> err <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;keys/mszlu.pem&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;keys/mszlu.key&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;证书读取错误&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 创建一个新的、空的 CertPool</span>
	certPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ca<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;keys/ca.crt&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;ca证书读取错误&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 尝试解析所传入的 PEM 编码的证书。如果解析成功会将其加到 CertPool 中，便于后面的使用</span>
	certPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span>
	<span class="token comment">// 构建基于 TLS 的 TransportCredentials 选项</span>
	creds <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		<span class="token comment">// 设置证书链，允许包含一个或多个</span>
		Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>cert<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// 要求必须校验客户端的证书。可以根据实际情况选用以下参数</span>
		ClientAuth<span class="token punctuation">:</span> tls<span class="token punctuation">.</span>RequireAndVerifyClientCert<span class="token punctuation">,</span>
		<span class="token comment">// 设置根证书的集合，校验方式使用 ClientAuth 中设定的模式</span>
		ClientCAs<span class="token punctuation">:</span> certPool<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	rpcServer <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">Creds</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">)</span>

	service<span class="token punctuation">.</span><span class="token function">RegisterProdServiceServer</span><span class="token punctuation">(</span>rpcServer<span class="token punctuation">,</span>service<span class="token punctuation">.</span>ProductService<span class="token punctuation">)</span>

	listener <span class="token punctuation">,</span>err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;:8002&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;启动监听出错&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> rpcServer<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;启动服务出错&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;启动grpc服务端成功&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>客户端：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token comment">//file, err2 := credentials.NewClientTLSFromFile(&quot;client/keys/mszlu.pem&quot;, &quot;*.mszlu.com&quot;)</span>
	<span class="token comment">//if err2 != nil {</span>
	<span class="token comment">//	log.Fatal(&quot;证书错误&quot;,err2)</span>
	<span class="token comment">//}</span>
	<span class="token comment">// 证书认证-双向认证</span>
	<span class="token comment">// 从证书相关文件中读取和解析信息，得到证书公钥、密钥对</span>
	cert<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;client/keys/test.pem&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;client/keys/test.key&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// 创建一个新的、空的 CertPool</span>
	certPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ca<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;client/keys/ca.crt&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// 尝试解析所传入的 PEM 编码的证书。如果解析成功会将其加到 CertPool 中，便于后面的使用</span>
	certPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span>
	<span class="token comment">// 构建基于 TLS 的 TransportCredentials 选项</span>
	creds <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		<span class="token comment">// 设置证书链，允许包含一个或多个</span>
		Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>cert<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// 要求必须校验客户端的证书。可以根据实际情况选用以下参数</span>
		ServerName<span class="token punctuation">:</span> <span class="token string">&quot;*.mszlu.com&quot;</span><span class="token punctuation">,</span>
		RootCAs<span class="token punctuation">:</span>    certPool<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;:8002&quot;</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;服务端出错，连接不上&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	prodClient <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">NewProdServiceClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>ProductRequest<span class="token punctuation">{</span>
		ProdId<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	stockResponse<span class="token punctuation">,</span> err <span class="token operator">:=</span> prodClient<span class="token punctuation">.</span><span class="token function">GetProductStock</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;查询库存出错&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>stockResponse<span class="token punctuation">.</span>ProdStock<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="_5-token认证"><a href="#_5-token认证" class="header-anchor">#</a> 5. Token认证</h3> <h4 id="_5-1-服务端添加用户名密码的校验"><a href="#_5-1-服务端添加用户名密码的校验" class="header-anchor">#</a> 5.1 服务端添加用户名密码的校验</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">var</span> authInterceptor grpc<span class="token punctuation">.</span>UnaryServerInterceptor
	authInterceptor <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>
		ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
		req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span>
		handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">,</span>
	<span class="token punctuation">)</span> <span class="token punctuation">(</span>resp <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//拦截普通方法请求，验证 Token</span>
		err <span class="token operator">=</span> <span class="token function">Auth</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 继续处理请求</span>
		<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	server <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span>authInterceptor<span class="token punctuation">)</span><span class="token punctuation">)</span>
	service<span class="token punctuation">.</span><span class="token function">RegisterProdServiceServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span>service<span class="token punctuation">.</span>ProductService<span class="token punctuation">)</span>

	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:8002&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;服务监听端口失败&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;服务、启动失败&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;启动成功&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token function">Auth</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;missing credentials&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> user <span class="token builtin">string</span>
	<span class="token keyword">var</span> password <span class="token builtin">string</span>

	<span class="token keyword">if</span> val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> md<span class="token punctuation">[</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		user <span class="token operator">=</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> md<span class="token punctuation">[</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		password <span class="token operator">=</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> user <span class="token operator">!=</span> <span class="token string">&quot;admin&quot;</span> <span class="token operator">||</span> password <span class="token operator">!=</span> <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unauthenticated<span class="token punctuation">,</span> <span class="token string">&quot;token不合法&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h4 id="_5-2-客户端实现"><a href="#_5-2-客户端实现" class="header-anchor">#</a> 5.2 客户端实现</h4> <p>客户端需要实现 <code>PerRPCCredentials</code> 接口。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> PerRPCCredentials <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// GetRequestMetadata gets the current request metadata, refreshing</span>
	<span class="token comment">// tokens if required. This should be called by the transport layer on</span>
	<span class="token comment">// each request, and the data should be populated in headers or other</span>
	<span class="token comment">// context. If a status code is returned, it will be used as the status</span>
	<span class="token comment">// for the RPC. uri is the URI of the entry point for the request.</span>
	<span class="token comment">// When supported by the underlying implementation, ctx can be used for</span>
	<span class="token comment">// timeout and cancellation. Additionally, RequestInfo data will be</span>
	<span class="token comment">// available via ctx to this call.</span>
	<span class="token comment">// TODO(zhaoq): Define the set of the qualified keys instead of leaving</span>
	<span class="token comment">// it as an arbitrary string.</span>
	<span class="token function">GetRequestMetadata</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> uri <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// RequireTransportSecurity indicates whether the credentials requires</span>
	<span class="token comment">// transport security.</span>
	<span class="token function">RequireTransportSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>GetRequestMetadata</code> 方法返回认证需要的必要信息，<code>RequireTransportSecurity</code> 方法表示是否启用安全链接，在生产环境中，一般都是启用的，但为了测试方便，暂时这里不启用了。</p> <p>实现接口：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Authentication <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    User     <span class="token builtin">string</span>
    Password <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Authentication<span class="token punctuation">)</span> <span class="token function">GetRequestMetadata</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>
    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">:</span> a<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">:</span> a<span class="token punctuation">.</span>Password<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Authentication<span class="token punctuation">)</span> <span class="token function">RequireTransportSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>应用：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>auth<span class="token punctuation">.</span>Authentication<span class="token punctuation">{</span>
		User<span class="token punctuation">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span>
		Password<span class="token punctuation">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;:8002&quot;</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>grpc<span class="token punctuation">.</span><span class="token function">WithPerRPCCredentials</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="新版本"><a href="#新版本" class="header-anchor">#</a> 新版本</h2> <p>前面的课程中，我们使用的proto的go生成器，使用的命令是</p> <p>go get github.com/golang/protobuf/protoc-gen-go，在https://www.grpc.io/docs/languages/go/quickstart/ 中，我们发现</p> <p><img src="/assets/img/image-20220513194110535.dc9745c9.png" alt="image-20220513194110535"></p> <p>官方使用的和我们使用的并不一致。</p> <p>github的方式，需要使用<code>--go_out=plugins=grpc</code> 来去进行生成，而在golang.org方式中，弃用了这种方式，使用<code>protoc-gen-go</code>将不在支持gRPC service的定义，需要使用新的插件<code>protoc-gen-go-grpc</code>。</p> <blockquote><p>所以，这里，我们以新的方式，重新实现一下服务端和客户端</p></blockquote> <h3 id="_1-使用google-golang-org-protobuf"><a href="#_1-使用google-golang-org-protobuf" class="header-anchor">#</a> 1. 使用google.golang.org/protobuf</h3> <ol><li><p>安装插件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ go <span class="token function">install</span> google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
$ go <span class="token function">install</span> google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>安装完成后会在gopath下的bin目录下生成</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAxsAAAA5CAYAAABeUjZpAAAey0lEQVR4nO2dv28bydnHv3yRf8BpaG4byoUhULAIHAKpJ040A7i6ljBAkN2SKYxToguCIMeEed1QbAIRBAS2rgyEJg32YrcyRAguLJXB0tvkgHSv5RPfYmZ//+DMcnkUpecDCLojZ595dnZWfp6Z53kmNZ/P5yAIgiAIgiAIgkiY/1m3AgRBEARBEARB3E/I2SAIgiAIgiAIYiWQs0EQBEEQBLFxGBi3VPSn69aDIKIhZ4MgCIIgCGLjMDDTAW04hrFGLaZ9FaqqQlX7SN7vYQ5Va7zOOySW5VfLCnj9j7/jp5/+E+vaR49+jVff/2FZFQiCIAiCIB4YOZQreWi9Ad5PCyjnFl9hjFtoDvRYvSmlIxwW0sC0D7Wn2V/kK+h0cgAMGIaB8WkTi7rIVzpC+gLA44wCfdBE/7H4NcTdYmlnQ8bReP67F3j3r7fW77hOCkEQBEFsEtO+Cqd9hnwFnRDLyWcQRrSVkSvT1qENxq0mBnoelU4ZuSA5tkCrjagsj4JQe4iQMUVf7cF9C0sYoAv7uxuEj7eN1lMR1sQ3RkoJR4cFpF2t2LM53+UORdB35v/myuh0ytbnA6tdGum0wbsIkgOYzzBI/iIHJeoew/vbDOK9m9bV8u9FkMMYcIHM36IolnY2AOAvf/2bcNtvvvnG+v3nP/0xie5XwqiWQrFbxXB+goN1K0MQBEFsKCGGlNaDqvmN7kDDUutBnXkNRBm5cjq41b/AuQ4opW95GwOfZ9F3HIpPFv/YZdDkQ64do9UcwH8LKmaShqZQf3eNQAfhnvEQ7tFHxLvpe+eDLpd/L8L+xvSfuR0U8b9Fi0nE2QCAXo95qpVKBZl//hu4vQXmc8xv55jPb4HbOYzf/8bV7u5yjU+X69aBIAiC2Him7zHQvSuNpoGhYTj+FjnTIJj2+T/uTgeAr1rqA5yOd2zjQUquRFuf+gPoUFDa8XwfwzD0y3KuyCpQFB161Oq2t0++OqsP3mNaENmdkOxvA5j2VfQCjD9mKC7aaSLWDn833e+8+W4KhsdJvBfGuMX/xigoHR3CfO2NcQvvXXpJ/C0SIDFnw+k83H65AeZz7mxwp+PnW187giAIgrjfPAsw+NIovCzhvDmAPjMAbiZMP2hgRoCzfQ7loxJmzQH08wsYBdOoEJcr19bJFB80APkibLuCJSUj/1hyBTpIFoM5QczACrX90wUcHno+y5VRyWvoaTN8NoCcoEJC/d1F+Cp2xuE0pjMKoM3gfoLmWD9biaPhW/HWe1AtA/Yl+2jQhDoIupoRtZ8kEjZm4zaaNw2DbxO6d/vsd3O2aGLLvBfGGKcDHUFjli4couwQIfe3aDEr2dmY39y4djTmt8zx8LaLZFRDqthFdTjHycE1jve30JiYX/rDm66P97HVmKA6nOPVJ/bf2Gvj6qyOrEemi+oQ8xNbEgufMv+vi2KK/c9e+wpn9SwcDRfK8twQaqkinFf4ZArg1g9sfMB0CZTn0zMgNGzkvB4Lx/qX0xULxjSw0+j7Nb/3zg3Yc8jXp8gYEgRBBJHLCRp83EBUduHdREB6B7vKALruMCqF5Uq2dWCMh2A26/Ima7CsHMqdzjJSeUhXBo+FrJ5l+1sz6cfIAC4DNP04A8BrVH7GDICSCRkUfYBmmCeghzsJyi77nSt3wFI2eAiPK47fwBiyORtuLPlhOEKH8pXNdTQA8/mFu7wZsYntIfi9MC7OoQNQSi8XjJnk3yIBVrOzcfOVOxlsV+P2ljkd3nZi+I105gRcon11Bp+t/ukYZdtS5nidFaeoIlJSuRnysiwj1sOkUcbx84B7kOi3W0wB1WrgFV5jn18RPna4wvF+0dNHF8UUJI1rWV2TeT5C93twgqv2JbYaDZSPn9sOzzWfN5HOZ4hMgiAIScx/+C3jmxuIyATtGKTBbJLFK/g+uTI6uJji/UAHlBK+dcVhcD01czWbEZ2gGyJrSaZ9FuvuzQG5v+TwLA9ozlXldAYKNJxfGCjw8WfPNSD0zWTZBHHzUz5/3KRROOygEHEPwg5fwE6OlW9zX/I7zF2IwSnGO6bjZGB8ypy4wxgTO+y9MGZsV2N3J+1L/HaFWCb0t8hJYuds9Ho9a9fi9ssNfv7yBbc3X/HzlxvMv3zF7c1NLLmXP/6Iy/YV5vM5/7lCew8AJmi8HvnadxsNbA95W75yfX1c5oZsFUNLjlNWF8Uak3Vw4vzcbm8apTKyAACjmuVoVIfO9nNctbeFxyG032EV3a7PGsb18T4zkvfauPK0Dxu7SaOIxvbQoeMQzDXo4q2/eYK6So5pYJ/i95ut99HeAyaN12CfXuO43MAEVQwdjkacMSQIgljItM/+oc9Xki3lKSN3UdvpB7DFzR0hg04fNKGGnS4nKSuUaZ+f58B+ehozkja5CpEs6YwC6Oe4MI+d4LsdLBSOwYxK0d2euBi4OOfG6myIFn/29pkbi35a8B2d4TNud1AsKdB6rH2rpaI50JGvdNC5D44GJ1fuoJLXMWiaY9PEICNR9UnovbB3O3DhL3+s9VZ7OGRizkalUrF2LW6/3GB+89X+fXPD8jhiMNn+wRNuk0X9jBvBl59w7b2gOoQ76uYa795MAOyhfeVdHXfI6r7FYtNRXtbobZerNYc3GihbPxHe1WD9BqzwH5zgilnkwe09oUI4OMGwiuD73WvjyqXkAV5x2ZeffCOdsK7LPB/Z+82i3m9jjzsxzNnx9h9zDAmCICKY9lVWcjJmCckk5C5ua2A81ADkUfQa8ukCDjsddJw/FR6Br/UCDJYIWQmg9QKM1ntMemcXCnTYvkUaGQXA7DM/2G+1+RoWxgXOdQWKAkDXoWs9tMYGC4FyzY8K8mDGr/tzgfCndBq5wiGXwZL5lyp1fCeZoq+GVH0KcsgECX8vNAwGGVQcz+KopLBvVng45EpyNm5vvtpJ4Xw1GJjHklt9ERQ8s4WnewAmH3EFuAxBf/srfJwA2PsOzwMNe1OWiDayskZ4y1fGXy2IAQoMtbLyCsx+n2Ir4Nrsk23PDfD2jpwTP5f4dA0cOO5j77vn8N6WX/aKdF3q+cS432wdZ8OPSBWL2ALLn3E7fvHGkCAIIhizEtIyCa1Bq9UycgXb8hK1wgZrroxOBVB7GrQPU5RzjqtkZS3qxxnMz8NsBs0WsMFJwtF4Sg3znQx7nHlYi5kkzkNgksizidTq4hx6fhelmc5yNp59gNpzhgLF4TPGrV7keRthZ21sqhMy7fPqaB7H3wxzGpyOsbNoF0fqvfAmfQPpwkuUzpsY6Oe4MAoRIXBO5HbOVpKz8d///W1SYh8M2foZ5vWQL68/4RIAtp/4nIF1sEm6EgRBrB3zAK2oXQcrHOYzDOR88fSBZ1uIyI3R1ipRK5Ngkc5AgT/VNZYs4T4LOKzMoPbcOQv3EivEiOdtOOZJmm1t4LMBpHm+xm7IUBgzHdD1pRLEWQ4OUDraAU5541wZlbyKDzJZw7ZWmOkszK5QDjF2p32ovZnPSWZGORCWC3+3MROxSzjyvJPpwiEqMxU9jTsAMvcn/V6YeRjm/8b4W7SApZ2NR48exT6c79GjRwvbXAYtHV+/w5uI1fNAAnZBGNEr8cvJMlfl3+DddT1+MnH2CbYBTLpvMTo58CVKm6FaNrxf+CsurRxpXTlLPZ849ztCjVelam830PAl669xDAmCuD8YY7R6msAJxzwcRg8wLoJ2B4TlSraNqkQT2ceMVbpxWX0xZcUgvHzvpmMa4va9sXK39jxhFY00zAwD/NTEkPHmhmKgwymeIG6Mh9DyRXTSwNjRKlfuIGeM0VL9h8zBuyORRBihWco1X7mnu1rLY78XaezsKhjoPATPNV5eB0Lyb5EASzsbr75f7Sngk8YW9uEskzpCbasBFnnjD/vxw/IOuo2gqkrXON5nla6CZXnDZGRlZfH8uz00JhM0tvYBT/Wi6+Ma3j0Xyds4wIsq0O12Udx/6jJ+rSRmF7zfRgOsW7exPKql8PaFP4ckGWR1Xeb5mMjeryl3D+1+HfXsE3zsFtHYquGJ1f86x5AgiPsCW9nPoyKwumgaA4NmH4+dB2mZZT4doTHicuXaWiVqiyGhG9M+1A/P3IaiuWvCK90Iy5Jg2lcxzHgMYe5EAasPG1obPCzKWQLVdi7AjEYzjMYYo6UDSiksEd/vuMRSaQa+UxUQ4Z8u4LDj3JvgpW6jwpyMz5h55o6oIjryqGxi/BQA26j3H5JnH74XHa4k816kd3ahDHRovRYyrgP9TlnomnUGjtzfIhESC6NaFdV2G5eNLaQani/22ugLbhVk632032yhMQmJv/fJyoKlFkzQ2EqhAftMDFlZ2foZhh9TKHZtWY7GaD8XugUcvGpjr9vAZNLAlmswqhgOt1H0WPHZ+g+oNoro+trzq16I9RsHeV3lxtQsR+s8q0Pmfkc1Vma3OjSdvwOcDKvoFrso1l5YpW/XOYYEQdwHzBVDDT01KNIccB6wZcdOB7R3VY2SkSvXllUYyiPSlvCUvbWkuOr3C8qSIPSguKSresE+WM65GyT6WZKw8rJ5FF3Hk3hi9F1tI0reBjgucciVDxNNPmd6Z1CUVStXxiYfm+I6WDNkbucrjvwK7tR755rwe5Eu4GXpnOWCNFW4L3GHOor/LRJ7LxKrRrUyntRxdtWGq4ZRdWiVtRUji/rZPKASEjNYg2QdnJhlX5OQZZZLdWMbuyK3UMfZ3KtT1PkTBziZzxHQbWBlrESR1lV+TP2I3a91boa3aplVYaqIlFVmd41jSBDEA4SdUVDxHK+slI4SrVwVyvR9zHMrFJSOPKU2Y8sKhpUHDe73FxmbtcAdNqGQFd42ImTNdFzu1iaQzD3eQ9IFHHaOwAtCOcij0nHvBrHTxt07QLLvRbpwaFePs5qXcOSrDpbs36LUfD6PVyZq1bhOEF+3Mncb5+npd32sNklXgiCIhwRbjVymWtZqZD1YnEnRsE/NloWtLhvoqz3MQndgonI2piHXsmusMyGscDphxXBUnKEZkPjtY9oHi8YqP0ynBPydmm3mYYZ3PoyKWMQIrxvsnIqnwhnu62KTdCUIgnhAGGOw4zCKyzsHScp6wEw/sJAZNobeXAhZYe+hKSUcCT4Q7wnTEMn5CQnvilSrr4YkeHNHxqGCUjp6sI6GWWwhPB/nbkM7G5vCqIbUj089icoj1FIsgdo+5+IOsEm6EgRBEARB3GWMMVrNc+xu6E7h3XU2CIIgCIIgCILYaO5+gjhBEARBEARBEBsJORsEQRAEQRAEQawEcjYIgiAIgiAIglgJ5GwQBEEQBEEQBLESyNkgCIIgCIIgCGIlkLNBEARBEARBEMRKIGeDIAiCIAiCIIiVQM4GQRAEQRAEQRArgZwNgiAIgiAIgiBWAjkbBEEQBEEQBEGsBHI2CIIgCIIgNg4D45aK/nTdehBENORsEARBEARBbBwGZjqgDccw1qjFtK9CVVWoah/J+z3MoWqN13mHxLL8alkBr//xd/z0039iXfvo0a/x6vs/LKsCQRAEQRDEAyOHciUPrTfA+2kB5dziK4xxC82BHqs3pXSEw0IamPah9jT7i3wFnU4OgAHDMDA+bWJRF/lKR0hfAHicUaAPmug/Fr+GuFss7WzIOBrPf/cC7/711vod10khCIIgiE1i2lfhtM+Qr6ATYjn5DMKItjJyZdo6tMG41cRAz6PSKSMXJMcWaLURleVREGoPETKm6Ks9uG9hCQN0YX93g/DxttF6KsKa+MZIKeHosIC0qxV7Nue73KEI+s7831wZnU7Z+nxgtUsjnTZ4F0FyAPMZBslf5KBE3WN4f5tBvHczUFDwnDbGaDUHiB5i/3uZlF5LOxsA8Je//k247TfffGP9/vOf/phE9ythVEuh2K1iOD/BwbqVIQiCIDaUEENK60HVBP5xN9vOvAaijFw5HdzqX+BcB5TSt7yNgc+z6DsOxSeLf+xyrvIh1wYbS1pPxUzS0BTq764R6CDcMx7CPfqIeDd973yElMTndDJ6mSTibABAr8c81Uqlgsw//w3c3gLzOea3c8znt8DtHMbvf+Nqd3e5xqfLdetAEARBbDzT9xjo3tVl8x9yDcPxt8iZhvK0zx0NpwPAV/P1AU7HO7ZRLSVXoq1P/QF0KCjteL6PYRj6ZTl3KhQoig49aunV2ycP59EH7zEtiOxOSPa3AUz7KnoBxh9zWhftNBFrh7+b7nfefDdFwuME53S6gMNOIUQEe4/yFcdcWVovN4k5G07n4fbLDTCfc2eDOx0/3/raEQRBEMT95lmAwZdG4WUJ580B9JkBcDNx+kEDoKB05GyfQ/mohFlzAP38AkbBNCrF5cq1dTLFBw1AvgjbF2FJycg/llyBDpLFYE4QM2RCbf90AYeHns9yZVTyGnraDJ8NICeokFB/dxG+u5NxOI3pjAJoM7ifoDnWz1biaPh23/QeVA1gc/cl+2jQhDoIupoRtfYuEjZmo6B0dOibU5uCwbcJ3bt99rs5E5zY8ee0gfFQA5QSvnVMlqT0MkmsGlWv17N2LeY3N7j9coOfv3xhv//vBrc3X33tIhnVkEqlUBsBwDWO91NIpcyfGkae5tfH+1Z7879T+8e4DpDp+qm5JY1qKaRSW2hMAKCLIm+3f+ySJCTLcwFqnvY+mQIw/eyf2sjWJVCeT0//2LmvXzzWv5yui8Y0mf4j547kPHT0Hv95L3pm5vfe+e24F9+4icwDgiCSJ5cTNPi4gajswruJgPQOdhUA+syuOiQsV7KtA2M8BLNZlzdZg2XlUO4sk/RrhnRl8FjI7lm2vzWTfowMwAw966MMAOZsWRifMQOgZEIGRR+gqZoVpMwfFjKjD5qez+3vTHLlDjqdDjpHJSgATxDvoNOxjX6ldMQ/8/5UFgb5WPLDfsx+AeQrm+toAObzCyezcGIvN6eN8Snb9Sy6d8aW18tNYs5GpVKxdi1ub75ifvMV8y/s9y13PrztxBihZhn/Jl0UU/sItN0+HaPsbgzLSCx2/e27RUnDS14WMwCL8F4xaZSD7yGiX2+33WIKtbfBV4xqQXpGjB2ucLwfNNayhqmsrkk+nzj9cwLnjon4PFzmeQs9s4MTXLX3gEkDZafAa65/dYj5iZ1pJD8PCIJYNcbFOXQ4jG9uICITtGOQBvu332NUisiN3XaK9wPdt+Jp6an1XAZpdGnSEFlLMu0zI9ibA3J/yeFZHmyHy/wonYECHecX9viz56pg1+e1cpQSjnxG/BFKSpiTwL7zYs4fN2kUDjsROTQSxrExRkt1nyNijFtQmwPo/B421nE0yZVRyQP64BT2K2RgfDqAnq+s+P74exnUT8J6rWRnw9rVuPmKn7/cYP6FORxxuPzxR1y2rzCfz/nPFdp7ADBB47XfBO02Gtge8rZndWQBXB+XuZFYxdCS45TVRZGvBB+cOD+325/Vs4CkLADAqIYtbqFWh872c1y1t4XHIbTfYRXdrt9Ivz7eZ8b2XhtXnvZhYzdpFNHYHjp0HKLKRhVvJax9eV0lxzTh/k2C5o6J8Dxc4nnLPLNsvQ/mb7zmjtg1jssNTFDF0OFoxJkHBEGsmGmfJXMmbUzIyF3UdvoBbKNlRyhcSh80oYadLicpK5Rp3+Xg9DQWPrLJVYhkSWcUQD+H5Vvw3Q4WCscwZjrEd3viYuDinLsasyFa/NnbZ24s+mnB55/6HO0dFEsKtB5r32qpaA505CsddO5RInmu3EElr2PQdOwkZWJWo5KA7TYqKIWsACSp12p2Nr7csB0N87djZ0OWyfYPlqHPyKJ+xo3gy0++MBJUhzhxlY+6xrs3EwB7aF95K0s5ZHXfCqyey8save1yteYevYBs/QSuW1vYb0B1LHOVO6y9x2jGwQmGVQTf714bVy4lD/CKy778JLoEHlfXJJ5PnP4d+OaOjeg8jP+8ZZ9ZFvV+G3vcEWMOlncMY84DgiBWxrSvsjMK4pa2TEDu4rY8jht5FL2GfLqAQ+/Kd4UHxmi9gNOsI2QlgNYLMFrvMemdXSjQYfsWaWQUALPPfLdjtfkaFsYFznUFigJA16FrPbTGRkAIFAubyle8nwuEP6XTyBUOuQyW+LxUqeM7yRR9NaQCXZBDlmC/bLcxIGxzBXqtpBrV7c1XOymcr6QC81hyqy+CrL8tPN0DMPmIK8BlRPnbX+HjBMDed3geaOiZskS0kZU1wlu+qvxqQf3c6+N9a0XcYq+Nq7M6sla/T7EVcG32ybbnBnh7dFFMha3kX+LTNXDguI+9757De1t+2SvSVeL5JNu/TfBci/rOOw/Fn7efGM8sW8fZ8CNSxSK2AOy1rzzOTLx5QBDEKjCrxiyT0Bq0Wi0jV7AtL1ErbLDmyuhUALWnQfswRTnnzDSVlLWon07ZIZslTA+aLWCDk4Sj8ZQa5jsZ9jjzEDszSZyHuSWRZxOp1cU59PwuSjMder6CzrMPUHunGO8s8xw+Y9zqRZ63EXbWxqY6IdM+ryTlcfzNUraD0zF2VrCLY+VQFYNlJ63XSqpR/fd/f5uU2AdDtn6GeT3ky+tPuASA7Sc+Z2AdrFvXdfdPEAQhhXnictSugxUO8xkGcr4D1wLPthCRG6OtVaJWJsEinYEC+GL4Y8kS7rOAw8oMak/D+YWBwv30NhhWiBHL29Ac8yTNtjbw2QDSZr5GyFAYMx3QdTTDSkXp4VWklF3zv6Z4PwBKRzvAKW+cK6OSV/EhrLBZJKzCmbK7g0K5gMACrdM+1N7M5yQz4xcIy4W/25hFIUo48ryT6cIhKjMVPe0cF0YhYUfaDIHLI9gnTV6vpZ2NR48exT6c79GjRwvbXAYtu16/w5uI1etAAnZBGNEr4cvJMle+3+DddV0wZCqA7BNsA5h032J0cuA7ZNAM3bHh/cJc7f8FkdaVk9Tzidv/AsTm4TLPO84zG6FW7AJ7bbS3G2g0yjh+fubod43zgCAIhjFGq6cJnHDMw2H0gH/Eg3YHhOVKto2qihXZxww6vBWQYsqKQXj53k3HNMTte2Plbu15wioHaZgZBvipiSHjzZ3WQIdT/ARxYzyEli+ikwbGjla5cgc5Y4yWGnBStXdHIokwQmOMU553dJ/9zMRJcrdRkKWdjVffr/YU8EljC/u4csTLj1DbaoBF3vjDfvywvINuo4tiCp44/msc77OqQcGyvCEmsrKyeP7dHhqTCRpb+8DVmcsAvT6u4d1zkbyNA7yoAt1uF8X9py7D0UoAdsH7bTTAunUbmqNaCm9f+HMKkkFW12WeTxL9iyE2D5d53rLPzBybPbT7ddSzT/CxW0Rjq4Yn1hiucx4QBAGYK/t5VBYHqGNnV8FA1zFo9vHYeagfPznbGRojLleu7aLwCkz7UD88cxuK5q6JpwLSQlkSTPsqhhmPIcydKGD1YUNrg4dFOUuN2s4FmH9lhpcZY7R0QCmFJeL7HZdYKs3Ad6oCAvd9h8ex0D1EhTkZnzGLqp4VoYiOPCqbGD8FwF5g8BzYCbZjw6Z28on+iyvWJa9XYmFUq6LabuOysYVUw/PFXht9waXjbL2P9pstNCYhses+WVmw0P4JGlspNMDi4c/qWWlZ2foZhh9TKHZtWY7GaD8XugUcvGpjr9vAZNLAlmswqhgOt1H0WNHZ+g+oNoro+trzq16I9RsHeV1ln0+y/YsgOg9Fn/eoxkrzmvOKXSv+zEY1Voa3OjQdmgOcDKvoFrso1l5YpW/XOQ8IgjDDnzT01LBTyuz8iXThJUrn7FRvX3tX1SgZuXJto8MrOJp5iJtHSuml6/A/IVkShB4Ut4ISoebBcs7dINHPkoQZhnkUXceTeHJXXG0DTnu3GvgdlzjkyoeJrogzvTMoyqqVK6PTSVCRXxzHwZohc9t9qjdz6pebayLvpZxeIu9FYtWoVsaTOs6u2nDVEKoOfaVJo8mifjYPrES0174KlHVwYpZ9TUKWWWrUjW0oitxCHWdzr04BFZfsXnEynyOg28BKSYkirav8mCbbvwAS8zD+8xZ7Zqaj4queZVWYKjoO9VvjPCAIQhJ2RkHFc+qZUjpaeRlMAMD0fcxzKxSUjjwlaGPLCoaV4Qzu9xcZm7XADUOhcBfeNiJkzXRc7tYmkMw93kPSBRwGnmOSR8Vzjgg71TvGDpALtrsFJRO92yihlwipOSsVdfcY1ZAqdskgEsCszrQJY7VuXaX7p3lIEMQDga1GLlMtazWyHizOpGiwylsRhZpCYavLBvpqD7PQVfGonI1pyLXsGuvsBSucTlgxHBVnaAYkfvuY9sGiscoP0ykBf6dmJRxt4Bkjdz6MiljECK8b7JyKp8IZ7uti3bquu3+CIIg7ijEGOw6juLxzkKSsB8z0AwuZYWPozYWQFfYemlLCkeADMUuc2gjk/ISEd0Wq1VdDEry5I+NQQSkdPVhHwyy2EJ6Pc7ehnY1NYVRD6senniTfEWoplkBtnzNxB1i3rkn2T/OQIAiCIIh1YozRap5jd0N3Cu+us0EQBEEQBEEQxEZz9xPECYIgCIIgCILYSMjZIAiCIAiCIAhiJfw/1RYahOVvrsQAAAAASUVORK5CYII=" alt="image-20220513195044682"></p></li> <li><p>利用proto文件重新生成go文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>protoc  --go_out<span class="token operator">=</span>./service --go-grpc_out<span class="token operator">=</span>./service  pbfile<span class="token punctuation">\</span>product.proto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>修改之前的service实现</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> service

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> ProductService <span class="token operator">=</span> <span class="token operator">&amp;</span>productService<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> productService <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>productService<span class="token punctuation">)</span> <span class="token function">GetProductStock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> request <span class="token operator">*</span>ProductRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ProductResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ProductResponse<span class="token punctuation">{</span>ProdStock<span class="token punctuation">:</span> request<span class="token punctuation">.</span>ProdId<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>productService<span class="token punctuation">)</span> <span class="token function">mustEmbedUnimplementedProdServiceServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>测试</p></li></ol> <h3 id="_2-import使用"><a href="#_2-import使用" class="header-anchor">#</a> 2. import使用</h3> <blockquote><p>用于导入其他proto文件</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 这个就是protobuf的中间文件</span>

<span class="token comment">// 指定的当前proto语法的版本，有2和3</span>
syntax <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//从执行 protoc这个命令的当前目录开始算起，</span>
<span class="token keyword">import</span> <span class="token string">&quot;pbfile/user.proto&quot;</span><span class="token punctuation">;</span>

option go_package<span class="token operator">=</span><span class="token string">&quot;../service&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 指定等会文件生成出来的package</span>
<span class="token keyword">package</span> service<span class="token punctuation">;</span>

<span class="token comment">// 定义request model</span>
message ProductRequest<span class="token punctuation">{</span>
  <span class="token builtin">int32</span> prod_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1代表顺序</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义response model</span>
message ProductResponse<span class="token punctuation">{</span>
  <span class="token builtin">int32</span> prod_stock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1代表顺序</span>
  User user <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义服务主体</span>
service ProdService<span class="token punctuation">{</span>
  <span class="token comment">// 定义方法</span>
  rpc <span class="token function">GetProductStock</span><span class="token punctuation">(</span>ProductRequest<span class="token punctuation">)</span> <span class="token function">returns</span><span class="token punctuation">(</span>ProductResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="_2-1-any"><a href="#_2-1-any" class="header-anchor">#</a> 2.1 Any</h4> <blockquote><p>任意类型</p></blockquote> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token comment">// 使用any类型，需要导入这个</span>
<span class="token keyword">import</span> <span class="token string">&quot;google/protobuf/any.proto&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 定义入参消息</span>
<span class="token keyword">message</span> <span class="token class-name">HelloParam</span><span class="token punctuation">{</span>
  <span class="token comment">// any，代表可以是任何类型</span>
  <span class="token positional-class-name class-name">google<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span>Any</span> data <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 这个就是protobuf的中间文件</span>

<span class="token comment">// 指定的当前proto语法的版本，有2和3</span>
syntax <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//从执行 protoc这个命令的当前目录开始算起，</span>
<span class="token keyword">import</span> <span class="token string">&quot;user.proto&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 使用any类型，需要导入这个</span>
<span class="token keyword">import</span> <span class="token string">&quot;google/protobuf/any.proto&quot;</span><span class="token punctuation">;</span>

option go_package<span class="token operator">=</span><span class="token string">&quot;../service&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 指定等会文件生成出来的package</span>
<span class="token keyword">package</span> service<span class="token punctuation">;</span>

<span class="token comment">// 定义request model</span>
message ProductRequest<span class="token punctuation">{</span>
  <span class="token builtin">int32</span> prod_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1代表顺序</span>
<span class="token punctuation">}</span>

message Content <span class="token punctuation">{</span>
  <span class="token builtin">string</span> msg <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 定义response model</span>
message ProductResponse<span class="token punctuation">{</span>
  <span class="token builtin">int32</span> prod_stock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1代表顺序</span>
  User user <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  google<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span>Any data <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义服务主体</span>
service ProdService<span class="token punctuation">{</span>
  <span class="token comment">// 定义方法</span>
  rpc <span class="token function">GetProductStock</span><span class="token punctuation">(</span>ProductRequest<span class="token punctuation">)</span> <span class="token function">returns</span><span class="token punctuation">(</span>ProductResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>productService<span class="token punctuation">)</span> <span class="token function">GetProductStock</span><span class="token punctuation">(</span>context context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> request <span class="token operator">*</span>ProductRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ProductResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//实现具体的业务逻辑</span>
	stock <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">GetStockById</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>ProdId<span class="token punctuation">)</span>
	user <span class="token operator">:=</span> User<span class="token punctuation">{</span>Username<span class="token punctuation">:</span> <span class="token string">&quot;mszlu&quot;</span><span class="token punctuation">}</span>
	content <span class="token operator">:=</span> Content<span class="token punctuation">{</span>Msg<span class="token punctuation">:</span> <span class="token string">&quot;mszlu msg...&quot;</span><span class="token punctuation">}</span>
	<span class="token comment">//转换成any类型</span>
	any<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> anypb<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>content<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ProductResponse<span class="token punctuation">{</span>ProdStock<span class="token punctuation">:</span> stock<span class="token punctuation">,</span> User<span class="token punctuation">:</span> <span class="token operator">&amp;</span>user<span class="token punctuation">,</span> Data<span class="token punctuation">:</span> any<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_3-stream"><a href="#_3-stream" class="header-anchor">#</a> 3. stream</h3> <p>在 HTTP/1.1 的时代，同一个时刻只能对一个请求进行处理或者响应，换句话说，下一个请求必须要等当前请求处理完才能继续进行。</p> <blockquote><p>HTTP/1.1需要注意的是，在服务端没有response的时候，客户端是可以发起多个request的，但服务端依旧是顺序对请求进行处理, 并按照收到请求的次序予以返回。</p></blockquote> <p>HTTP/2 的时代，多路复用的特性让一次同时处理多个请求成为了现实，并且同一个 TCP 通道中的请求不分先后、不会阻塞，HTTP/2 中引入了流(Stream) 和 帧(Frame) 的概念，当 TCP 通道建立以后，后续的所有操作都是以流的方式发送的，而二进制帧则是组成流的最小单位，属于协议层上的流式传输。</p> <blockquote><p>HTTP/2 在一个 TCP 连接的基础上虚拟出多个 Stream, Stream 之间可以并发的请求和处理, 并且 HTTP/2 以二进制帧 (frame) 的方式进行数据传送, 并引入了头部压缩 (HPACK), 大大提升了交互效率</p></blockquote> <h4 id="_3-1-定义"><a href="#_3-1-定义" class="header-anchor">#</a> 3.1 定义</h4> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code> <span class="token number">1</span>  <span class="token comment">// 普通 RPC</span>
 <span class="token number">2</span>  <span class="token keyword">rpc</span> <span class="token function">SimplePing</span><span class="token punctuation">(</span><span class="token class-name">PingRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">PingReply</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">3</span>
 <span class="token number">4</span>  <span class="token comment">// 客户端流式 RPC</span>
 <span class="token number">5</span>  <span class="token keyword">rpc</span> <span class="token function">ClientStreamPing</span><span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">PingRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">PingReply</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">6</span>
 <span class="token number">7</span>  <span class="token comment">// 服务器端流式 RPC</span>
 <span class="token number">8</span>  <span class="token keyword">rpc</span> <span class="token function">ServerStreamPing</span><span class="token punctuation">(</span><span class="token class-name">PingRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">PingReply</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">9</span>
<span class="token number">10</span>  <span class="token comment">// 双向流式 RPC</span>
<span class="token number">11</span>  <span class="token keyword">rpc</span> <span class="token function">BothStreamPing</span><span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">PingRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">PingReply</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>stream</code>关键字，当该关键字修饰参数时，表示这是一个客户端流式的 gRPC 接口；当该参数修饰返回值时，表示这是一个服务器端流式的 gRPC 接口；当该关键字同时修饰参数和返回值时，表示这是一个双向流式的 gRPC 接口。</p> <h4 id="_3-2-客户端流"><a href="#_3-2-客户端流" class="header-anchor">#</a> 3.2 客户端流</h4> <p>定义：</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">rpc</span> <span class="token function">UpdateStockClientStream</span><span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">ProductRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token class-name">ProductResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//....	</span>
stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> prodClient<span class="token punctuation">.</span><span class="token function">UpdateProductStockClientStream</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;获取流出错&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	rsp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">prodRequest</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> rsp<span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>rsp<span class="token punctuation">:</span>
		recv<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">CloseAndRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		stock <span class="token operator">:=</span> recv<span class="token punctuation">.</span>ProdStock
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端收到响应：&quot;</span><span class="token punctuation">,</span> stock<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">prodRequest</span><span class="token punctuation">(</span>stream service<span class="token punctuation">.</span>ProdService_UpdateProductStockClientStreamClient<span class="token punctuation">,</span> rsp <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		request <span class="token operator">:=</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>ProductRequest<span class="token punctuation">{</span>
			ProdId<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		count<span class="token operator">++</span>
		<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token punctuation">{</span>
			rsp <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>productService<span class="token punctuation">)</span> <span class="token function">UpdateProductStockClientStream</span><span class="token punctuation">(</span>stream ProdService_UpdateProductStockClientStreamServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">//源源不断的去接收客户端发来的信息</span>
		recv<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到的流&quot;</span><span class="token punctuation">,</span> recv<span class="token punctuation">.</span>ProdId<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
		count<span class="token operator">++</span>
		<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token punctuation">{</span>
			rsp <span class="token operator">:=</span> <span class="token operator">&amp;</span>ProductResponse<span class="token punctuation">{</span>ProdStock<span class="token punctuation">:</span> recv<span class="token punctuation">.</span>ProdId<span class="token punctuation">}</span>
			err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">SendAndClose</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_3-3-服务端流"><a href="#_3-3-服务端流" class="header-anchor">#</a> 3.3 服务端流</h4> <p>定义：</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">rpc</span> <span class="token function">GetProductStockServerStream</span><span class="token punctuation">(</span><span class="token class-name">ProductRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">ProductResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>productService<span class="token punctuation">)</span> <span class="token function">GetProductStockServerStream</span><span class="token punctuation">(</span>request <span class="token operator">*</span>ProductRequest<span class="token punctuation">,</span> stream ProdService_GetProductStockServerStreamServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		rsp <span class="token operator">:=</span> <span class="token operator">&amp;</span>ProductResponse<span class="token punctuation">{</span>ProdStock<span class="token punctuation">:</span> request<span class="token punctuation">.</span>ProdId<span class="token punctuation">}</span>
		err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		count<span class="token operator">++</span>
		<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code>request <span class="token operator">:=</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>ProductRequest<span class="token punctuation">{</span>
		ProdId<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> prodClient<span class="token punctuation">.</span><span class="token function">GetProductStockServerStream</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;获取流出错&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		recv<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端数据接收完成&quot;</span><span class="token punctuation">)</span>
				err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">CloseSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端收到的流&quot;</span><span class="token punctuation">,</span> recv<span class="token punctuation">.</span>ProdStock<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_3-4-双向流"><a href="#_3-4-双向流" class="header-anchor">#</a> 3.4 双向流</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code>stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> prodClient<span class="token punctuation">.</span><span class="token function">SayHelloStream</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		request <span class="token operator">:=</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>ProductRequest<span class="token punctuation">{</span>
			ProdId<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		recv<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//websocket</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端收到的流信息&quot;</span><span class="token punctuation">,</span> recv<span class="token punctuation">.</span>ProdStock<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>productService<span class="token punctuation">)</span> <span class="token function">SayHelloStream</span><span class="token punctuation">(</span>stream ProdService_SayHelloStreamServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		recv<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端收到客户端的消息&quot;</span><span class="token punctuation">,</span> recv<span class="token punctuation">.</span>ProdId<span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		rsp <span class="token operator">:=</span> <span class="token operator">&amp;</span>ProductResponse<span class="token punctuation">{</span>ProdStock<span class="token punctuation">:</span> recv<span class="token punctuation">.</span>ProdId<span class="token punctuation">}</span>
		err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/docs/Go/GoBasics/tcpCodingBasics/tcpCodingBasics.html" class="prev">
            11.tcp编程基础知识
          </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-92abcef6><li class="level-2" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#认识grpc" class="sidebar-link reco-side-认识grpc" data-v-92abcef6>认识gRPC</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_1-什么是微服务" class="sidebar-link reco-side-_1-什么是微服务" data-v-92abcef6>1. 什么是微服务</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_2-grpc" class="sidebar-link reco-side-_2-grpc" data-v-92abcef6>2. gRPC</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_3-protobuf" class="sidebar-link reco-side-_3-protobuf" data-v-92abcef6>3. protobuf</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_4-grpc实例" class="sidebar-link reco-side-_4-grpc实例" data-v-92abcef6>4. gRPC实例</a></li><li class="level-2" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#认证" class="sidebar-link reco-side-认证" data-v-92abcef6>认证</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_1-生成自签证书" class="sidebar-link reco-side-_1-生成自签证书" data-v-92abcef6>1. 生成自签证书</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_2-服务端应用证书" class="sidebar-link reco-side-_2-服务端应用证书" data-v-92abcef6>2. 服务端应用证书</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_3-客户端认证" class="sidebar-link reco-side-_3-客户端认证" data-v-92abcef6>3. 客户端认证</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_4-双向认证" class="sidebar-link reco-side-_4-双向认证" data-v-92abcef6>4. 双向认证</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_5-token认证" class="sidebar-link reco-side-_5-token认证" data-v-92abcef6>5. Token认证</a></li><li class="level-2" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#新版本" class="sidebar-link reco-side-新版本" data-v-92abcef6>新版本</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_1-使用google-golang-org-protobuf" class="sidebar-link reco-side-_1-使用google-golang-org-protobuf" data-v-92abcef6>1. 使用google.golang.org/protobuf</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_2-import使用" class="sidebar-link reco-side-_2-import使用" data-v-92abcef6>2. import使用</a></li><li class="level-3" data-v-92abcef6><a href="/docs/Go/gRPc/gRPCBasics/gRPCBasics.html#_3-stream" class="sidebar-link reco-side-_3-stream" data-v-92abcef6>3. stream</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-a008c6ba data-v-a008c6ba><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-a008c6ba><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-a008c6ba></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-a008c6ba></path></svg></div><div class="reco-bgm-panel" data-v-2940e5b8><audio id="bgm" src="/audio/RunAground.mp3" data-v-2940e5b8></audio> <div class="reco-float-box" style="bottom:200px;z-index:999999;display:none;" data-v-2940e5b8 data-v-cc4d9216 data-v-2940e5b8><img src="/img/music/RunAground.jpg" data-v-2940e5b8></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-2940e5b8 data-v-cc4d9216 data-v-2940e5b8><div class="reco-bgm-cover" style="background-image:url(/img/music/RunAground.jpg);" data-v-2940e5b8><div class="mini-operation" style="display:none;" data-v-2940e5b8><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-2940e5b8></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-2940e5b8></i></div> <div class="falut-message" style="display:none;" data-v-2940e5b8>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-2940e5b8 data-v-cc4d9216 data-v-2940e5b8><div class="info-box" data-v-2940e5b8><i class="reco-bgm reco-bgm-music music" data-v-2940e5b8></i>搁浅</div> <div class="info-box" data-v-2940e5b8><i class="reco-bgm reco-bgm-artist" data-v-2940e5b8></i>周杰伦 / 七里香</div> <div class="reco-bgm-progress" data-v-2940e5b8><div class="progress-bar" data-v-2940e5b8><div class="bar" data-v-2940e5b8></div></div></div> <div class="reco-bgm-operation" data-v-2940e5b8><i class="reco-bgm reco-bgm-last last" data-v-2940e5b8></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-2940e5b8></i> <i class="reco-bgm reco-bgm-play play" data-v-2940e5b8></i> <i class="reco-bgm reco-bgm-next next" data-v-2940e5b8></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-2940e5b8></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-2940e5b8></i> <div class="volume-bar" data-v-2940e5b8><div class="bar" data-v-2940e5b8></div></div></div></div> <div class="reco-bgm-left-box" data-v-2940e5b8 data-v-cc4d9216 data-v-2940e5b8><i class="reco-bgm reco-bgm-left" data-v-2940e5b8></i></div></div></div><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/assets/js/app.27c88f04.js" defer></script><script src="/assets/js/3.c6d46792.js" defer></script><script src="/assets/js/1.1cb9ffe8.js" defer></script><script src="/assets/js/9.f28a3137.js" defer></script>
  </body>
</html>
